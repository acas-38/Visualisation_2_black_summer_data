<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AU Capitals Temperatures (Sep 2019 – Feb 2020)</title>
  <style>
    body{font-family: system-ui, Arial, sans-serif; margin:20px; line-height:1.45}
    h1{margin:0 0 8px}
    .vis{margin:24px 0}
    pre{background:#f6f8fa;padding:12px;border-radius:8px;overflow:auto}
    .ok{color:#116329}.warn{color:#9a6700}.err{color:#d1242f}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <h1>Australian Capital City Temperatures</h1>
  <p>Daily temperatures from Sep 2019 to Feb 2020. Data file: <code>au_capital_temps_Sep2019_to_Feb2020.csv</code></p>

  <div id="diag" class="vis"></div>

  <h2>Map — Mean Feb 2020 Tmax</h2>
  <div id="map" class="vis"></div>

  <h2>Daily Tmax — Sep 2019 → Feb 2020</h2>
  <div id="lines" class="vis"></div>

  <script>
    const csvUrl = "au_capital_temps_Sep2019_to_Feb2020.csv?v=4"; // cache-buster

    (async function diagnose(){
      try{
        const res = await fetch(csvUrl, {cache: "no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        const lines = text.split(/\\r?\\n/).filter(Boolean);
        const head = lines.slice(0, 6).join("\\n");
        const msg = [
          `<div class='ok'>Loaded CSV (${lines.length-1} data rows)</div>`,
          `<div>Header line:</div>`,
          `<pre>${(lines[0]||"").replace(/</g,"&lt;")}</pre>`,
          `<div>First 5 rows:</div>`,
          `<pre>${head.replace(/</g,"&lt;")}</pre>`
        ].join("");
        document.getElementById("diag").innerHTML = msg;
      }catch(e){
        document.getElementById("diag").innerHTML = `<div class='err'>Failed to load CSV: ${e}</div>`;
      }
    })();

    const cityCoords = [
      {"city":"Sydney","lon":151.2093,"lat":-33.8688},
      {"city":"Melbourne","lon":144.9631,"lat":-37.8136},
      {"city":"Brisbane","lon":153.0260,"lat":-27.4705},
      {"city":"Adelaide","lon":138.6007,"lat":-34.9285},
      {"city":"Perth","lon":115.8570,"lat":-31.9523},
      {"city":"Hobart","lon":147.3272,"lat":-42.8821},
      {"city":"Darwin","lon":130.8456,"lat":-12.4634},
      {"city":"Canberra","lon":149.1300,"lat":-35.2809}
    ];

    const mapSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 720, height: 520, config: {view: {stroke: null}},
      layer: [
        {
          data: {
            url: "https://vega.github.io/vega-datasets/data/world-110m.json",
            format: {type: "topojson", feature: "countries"}
          },
          transform: [{filter: "datum.id == 36"}],
          mark: {type: "geoshape", fill: "#eee", stroke: "#888"},
          projection: {type: "equalEarth", center: [134, -25], scale: 900}
        },
        {
          data: {url: csvUrl},
          transform: [
            {"filter": "substring(datum.date, 0, 7) == '2020-02'"},
            {
              "aggregate": [
                {"op": "mean", "field": "tmax_C", "as": "mean_tmax_Feb2020"},
                {"op": "mean", "field": "tavg_C", "as": "mean_tavg_Feb2020"}
              ],
              "groupby": ["city","state","station_id"]
            },
            {"lookup": "city", "from": {"data": {"values": cityCoords}, "key": "city", "fields": ["lon","lat"]}}
          ],
          projection: {type: "equalEarth", center: [134, -25], scale: 900},
          mark: {type: "circle", stroke: "white", strokeWidth: 1},
          encoding: {
            longitude: {field: "lon", type: "quantitative"},
            latitude: {field: "lat", type: "quantitative"},
            size: {field: "mean_tmax_Feb2020", type: "quantitative", title: "Mean Tmax (°C)", scale: {range: [60, 800]}},
            color:{field:"mean_tmax_Feb2020", type:"quantitative", title:"Mean Tmax (°C)"},
            tooltip: [
              {"field":"city", "type":"nominal"},
              {"field":"state", "type":"nominal"},
              {"field":"station_id", "type":"nominal", "title":"Station"},
              {"field":"mean_tmax_Feb2020", "type":"quantitative", "format":".1f"},
              {"field":"mean_tavg_Feb2020", "type":"quantitative", "format":".1f"}
            ]
          }
        }
      ]
    };

    const lineSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 720, height: 360,
      data: {url: csvUrl},
      transform: [
        {"calculate": "substring(datum.date, 0, 10)", "as": "date_str"},
        {"filter": "substring(datum.date, 0, 7) >= '2019-09' && substring(datum.date, 0, 7) <= '2020-02'"}
      ],
      mark: {"type": "line"},
      encoding: {
        x: {"field": "date_str", "type": "ordinal", "sort": "ascending", "axis":{"labelOverlap": true}, "title": "Date"},
        y: {"field": "tmax_C", "type": "quantitative", "title": "Daily Max Temp (°C)"},
        color: {"field": "city", "type": "nominal", "title": "City"},
        tooltip: [
          {"field": "date_str", "type": "nominal", "title": "Date"},
          {"field": "city", "type": "nominal"},
          {"field": "state", "type": "nominal"},
          {"field": "tmax_C", "type": "quantitative", "format": ".1f"},
          {"field": "tavg_C", "type": "quantitative", "format": ".1f"},
          {"field": "tmin_C", "type": "quantitative", "format": ".1f"},
          {"field": "prcp_mm", "type": "quantitative", "format": ".1f"}
        ]
      }
    };

    vegaEmbed("#map", mapSpec, {actions: false});
    vegaEmbed("#lines", lineSpec, {actions: false});
  </script>
</body>
</html>
